<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Libby Checker</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4">
  <div id="app" class="max-w-4xl mx-auto">
    <div class="bg-white rounded-lg shadow-lg p-4 mb-4">
      <h1 class="text-xl font-bold mb-4">Libby Checker</h1>
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-2">Library OverDrive URL</label>
          <input 
            type="text" 
            id="libraryUrl"
            placeholder="yourlibrary.overdrive.com"
            class="w-full px-4 py-3 border rounded-lg"
          />
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">Import Books</label>
          <div class="flex gap-2 mb-2">
            <button id="csvTab" class="flex-1 px-4 py-2 rounded-lg bg-indigo-600 text-white">CSV Upload</button>
            <button id="rssTab" class="flex-1 px-4 py-2 rounded-lg bg-gray-200 text-gray-700">RSS Feed</button>
          </div>
          
          <div id="csvUpload">
            <input 
              type="file" 
              id="csvFile"
              accept=".csv"
              class="w-full px-4 py-3 border rounded-lg"
            />
          </div>
          
          <div id="rssUpload" class="hidden">
            <textarea 
              id="rssContent"
              placeholder="Paste your Goodreads RSS feed content here...&#10;&#10;To get it:&#10;1. Go to your Goodreads shelf&#10;2. Find the RSS link at the bottom&#10;3. Open it in your browser&#10;4. Copy all the XML content (Ctrl+A, Ctrl+C)&#10;5. Paste it here"
              rows="6"
              class="w-full px-4 py-3 border rounded-lg font-mono text-sm"
            ></textarea>
            <button 
              id="parseRssBtn"
              class="mt-2 w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
            >
              Parse RSS Feed
            </button>
          </div>
          
          <p id="bookCount" class="text-sm text-gray-600 mt-2"></p>
        </div>

        <div id="shelfFilters" class="hidden">
          <label class="block text-sm font-medium mb-2">Filter by Shelf</label>
          <div id="shelfButtons" class="flex flex-wrap gap-2"></div>
          <p id="filterCount" class="text-sm text-gray-600 mt-2"></p>
        </div>

        <button 
          id="checkBtn"
          class="w-full px-6 py-4 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 disabled:bg-gray-300"
          disabled
        >
          Check Libby Availability
        </button>

        <button 
          id="clearBtn"
          class="w-full px-6 py-2 text-red-600 hover:bg-red-50 rounded-lg"
        >
          Clear All Data
        </button>
      </div>

      <div id="status" class="mt-4 p-4 bg-blue-50 rounded-lg hidden">
        <p class="text-sm text-blue-800"></p>
      </div>
    </div>

    <div id="results" class="bg-white rounded-lg shadow-lg p-4 hidden">
      <h2 class="text-lg font-bold mb-4">Results</h2>
      <div id="resultsList" class="space-y-3"></div>
    </div>
  </div>

  <script>
    let allBooks = [];
    let filteredBooks = [];
    let availableShelves = [];
    let selectedShelves = [];
    let importMethod = 'csv';

    // Load saved data
    const saved = localStorage.getItem('libbyCheckerData');
    if (saved) {
      try {
        const data = JSON.parse(saved);
        document.getElementById('libraryUrl').value = data.libraryUrl || '';
        allBooks = data.books || [];
        filteredBooks = allBooks;
        availableShelves = data.shelves || [];
        updateUI();
      } catch (e) {
        console.error('Failed to load saved data');
      }
    }

    // Tab switching
    document.getElementById('csvTab').addEventListener('click', function() {
      importMethod = 'csv';
      this.className = 'flex-1 px-4 py-2 rounded-lg bg-indigo-600 text-white';
      document.getElementById('rssTab').className = 'flex-1 px-4 py-2 rounded-lg bg-gray-200 text-gray-700';
      document.getElementById('csvUpload').classList.remove('hidden');
      document.getElementById('rssUpload').classList.add('hidden');
    });

    document.getElementById('rssTab').addEventListener('click', function() {
      importMethod = 'rss';
      this.className = 'flex-1 px-4 py-2 rounded-lg bg-indigo-600 text-white';
      document.getElementById('csvTab').className = 'flex-1 px-4 py-2 rounded-lg bg-gray-200 text-gray-700';
      document.getElementById('csvUpload').classList.add('hidden');
      document.getElementById('rssUpload').classList.remove('hidden');
    });

    // Save data
    function saveData() {
      const data = {
        libraryUrl: document.getElementById('libraryUrl').value,
        books: allBooks,
        shelves: availableShelves
      };
      localStorage.setItem('libbyCheckerData', JSON.stringify(data));
    }

    // Parse RSS
    document.getElementById('parseRssBtn').addEventListener('click', function() {
      const xmlContent = document.getElementById('rssContent').value;
      if (!xmlContent.trim()) {
        alert('Please paste RSS feed content');
        return;
      }

      try {
        const parser = new DOMParser();
        const xml = parser.parseFromString(xmlContent, 'text/xml');
        
        const parserError = xml.querySelector('parsererror');
        if (parserError) {
          throw new Error('Invalid XML content');
        }
        
        const items = xml.querySelectorAll('item');
        
        if (items.length === 0) {
          throw new Error('No books found in RSS feed');
        }
        
        allBooks = [];
        const shelves = new Set();
        
        items.forEach(item => {
          const titleElement = item.querySelector('title');
          const title = titleElement ? titleElement.textContent : '';
          
          const descElement = item.querySelector('description');
          const description = descElement ? descElement.textContent : '';
          
          let author = '';
          const authorMatch = description.match(/author:\s*([^\n<]+)/i);
          if (authorMatch) {
            author = authorMatch[1].trim();
          }
          
          if (!author) {
            const authorElement = item.querySelector('author_name');
            author = authorElement ? authorElement.textContent : '';
          }
          
          const shelvesElement = item.querySelector('user_shelves');
          const shelfText = shelvesElement ? shelvesElement.textContent : 'to-read';
          const bookShelves = shelfText.split(',').map(s => s.trim()).filter(s => s);
          
          bookShelves.forEach(shelf => shelves.add(shelf));
          
          if (title) {
            const cleanTitle = title.replace(/\s*\([^)]*\)\s*$/, '').trim();
            
            allBooks.push({
              title: cleanTitle,
              author: author || 'Unknown Author',
              shelves: bookShelves.length > 0 ? bookShelves : ['to-read']
            });
          }
        });
        
        availableShelves = Array.from(shelves).sort();
        filteredBooks = allBooks;
        selectedShelves = [];
        saveData();
        updateUI();
        
        alert(allBooks.length + ' books loaded from RSS feed!');
        
      } catch (error) {
        console.error('RSS parsing error:', error);
        alert('Failed to parse RSS feed: ' + error.message + '\n\nMake sure you copied the complete XML content.');
      }
    });

    // Parse CSV
    document.getElementById('csvFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(event) {
        const text = event.target.result;
        const lines = text.split('\n');
        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, '').toLowerCase());
        
        const titleIdx = headers.indexOf('title');
        const authorIdx = headers.findIndex(h => h === 'author' || h === 'author l-f');
        const shelfIdx = headers.indexOf('bookshelves');
        const exclusiveShelfIdx = headers.indexOf('exclusive shelf');
        
        allBooks = [];
        const shelves = new Set();
        
        for (let i = 1; i < lines.length; i++) {
          if (!lines[i].trim()) continue;
          
          const values = [];
          let current = '';
          let inQuotes = false;
          
          for (let j = 0; j < lines[i].length; j++) {
            const char = lines[i][j];
            if (char === '"') {
              inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
              values.push(current.trim());
              current = '';
            } else {
              current += char;
            }
          }
          values.push(current.trim());
          
          const cleanValues = values.map(v => v.replace(/^"|"$/g, '').trim());
          
          if (cleanValues[titleIdx]) {
            let bookShelves = [];
            
            if (exclusiveShelfIdx >= 0 && cleanValues[exclusiveShelfIdx]) {
              bookShelves.push(cleanValues[exclusiveShelfIdx]);
            }
            
            if (shelfIdx >= 0 && cleanValues[shelfIdx]) {
              cleanValues[shelfIdx].split(',').forEach(s => {
                s = s.trim();
                if (s && !bookShelves.includes(s)) bookShelves.push(s);
              });
            }
            
            if (bookShelves.length === 0) bookShelves = ['to-read'];
            
            bookShelves.forEach(shelf => shelves.add(shelf));
            
            allBooks.push({
              title: cleanValues[titleIdx],
              author: cleanValues[authorIdx] || 'Unknown',
              shelves: bookShelves
            });
          }
        }
        
        availableShelves = Array.from(shelves).sort();
        filteredBooks = allBooks;
        selectedShelves = [];
        saveData();
        updateUI();
      };
      reader.readAsText(file);
    });

    // Update UI
    function updateUI() {
      document.getElementById('bookCount').textContent = allBooks.length > 0 ? allBooks.length + ' books loaded' : '';
      document.getElementById('checkBtn').disabled = allBooks.length === 0 || !document.getElementById('libraryUrl').value;
      
      if (availableShelves.length > 0) {
        document.getElementById('shelfFilters').classList.remove('hidden');
        const shelfButtons = document.getElementById('shelfButtons');
        shelfButtons.innerHTML = '';
        
        availableShelves.forEach(shelf => {
          const btn = document.createElement('button');
          btn.textContent = shelf;
          btn.className = 'px-3 py-2 rounded-full text-sm ' + 
            (selectedShelves.includes(shelf) ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700');
          btn.onclick = () => toggleShelf(shelf);
          shelfButtons.appendChild(btn);
        });
        
        document.getElementById('filterCount').textContent = 
          'Showing ' + filteredBooks.length + ' of ' + allBooks.length + ' books';
      }
    }

    // Toggle shelf filter
    function toggleShelf(shelf) {
      if (selectedShelves.includes(shelf)) {
        selectedShelves = selectedShelves.filter(s => s !== shelf);
      } else {
        selectedShelves.push(shelf);
      }
      
      if (selectedShelves.length === 0) {
        filteredBooks = allBooks;
      } else {
        filteredBooks = allBooks.filter(book => 
          book.shelves.some(s => selectedShelves.includes(s))
        );
      }
      
      updateUI();
    }

    // Check availability
    document.getElementById('checkBtn').addEventListener('click', async function() {
      const libraryUrl = document.getElementById('libraryUrl').value.trim();
      if (!libraryUrl || filteredBooks.length === 0) return;

      document.getElementById('checkBtn').disabled = true;
      document.getElementById('status').classList.remove('hidden');
      document.getElementById('results').classList.add('hidden');
      
      const libraryKey = libraryUrl.replace(/https?:\/\//, '').split('.')[0];
      const results = [];
      
      // Use CORS proxy to bypass CORS restrictions
      const corsProxy = 'https://api.allorigins.win/raw?url=';
      
      for (const book of filteredBooks) {
        document.getElementById('status').querySelector('p').textContent = 
          'Checking: ' + book.title + ' by ' + book.author;
        
        try {
          const searchQuery = encodeURIComponent(book.title + ' ' + book.author);
          const searchApiUrl = 'https://thunder.api.overdrive.com/v2/libraries/' + libraryKey + 
            '/media?query=' + searchQuery + '&perPage=5';
          const searchUrl = corsProxy + encodeURIComponent(searchApiUrl);
          
          const searchResponse = await fetch(searchUrl);
          
          if (!searchResponse.ok) throw new Error('Search failed');
          
          const searchData = await searchResponse.json();
          
          if (!searchData.items || searchData.items.length === 0) {
            results.push({
              title: book.title,
              author: book.author,
              error: 'Not found in library catalog'
            });
            continue;
          }
          
          const media = searchData.items[0];
          const availApiUrl = 'https://thunder.api.overdrive.com/v2/libraries/' + libraryKey + 
            '/media/' + media.id + '/availability';
          const availUrl = corsProxy + encodeURIComponent(availApiUrl);
          const availResponse = await fetch(availUrl);
          
          if (!availResponse.ok) throw new Error('Availability check failed');
          
          const availData = await availResponse.json();
          
          const result = {
            title: book.title,
            author: book.author,
            available: availData.available || false,
            waitWeeks: availData.estimatedWaitDays ? Math.ceil(availData.estimatedWaitDays / 7) : 0,
            holds: availData.numberOfHolds || 0,
            copies: availData.copiesOwned || 0,
            type: media.type ? media.type.id : 'unknown'
          };
          
          results.push(result);
          
        } catch (error) {
          console.error('Error checking:', book.title, error);
          results.push({
            title: book.title,
            author: book.author,
            error: 'Check failed: ' + error.message
          });
        }
        
        await new Promise(resolve => setTimeout(resolve, 2000));
      }
      
      displayResults(results);
      document.getElementById('status').classList.add('hidden');
      document.getElementById('checkBtn').disabled = false;
    });

    // Display results
    function displayResults(results) {
      const resultsList = document.getElementById('resultsList');
      resultsList.innerHTML = '';
      
      results.forEach(r => {
        const div = document.createElement('div');
        div.className = 'border border-gray-200 rounded-lg p-4';
        
        let html = '<h3 class="font-semibold">' + r.title + '</h3>';
        html += '<p class="text-sm text-gray-600 mb-2">' + r.author + '</p>';
        
        if (r.error) {
          html += '<p class="text-red-600 text-sm">⚠ ' + r.error + '</p>';
        } else {
          if (r.available) {
            html += '<p class="text-green-600 text-sm font-medium">✓ Available now</p>';
          } else if (r.waitWeeks > 0) {
            html += '<p class="text-orange-600 text-sm">⏱ ' + r.waitWeeks + ' week wait</p>';
            html += '<p class="text-xs text-gray-500">' + r.holds + ' holds on ' + r.copies + ' copies</p>';
          } else {
            html += '<p class="text-gray-500 text-sm">✗ Not currently available</p>';
          }
          html += '<p class="text-xs text-gray-400 mt-1">Format: ' + r.type + '</p>';
        }
        
        div.innerHTML = html;
        resultsList.appendChild(div);
      });
      
      document.getElementById('results').classList.remove('hidden');
    }

    // Clear data
    document.getElementById('clearBtn').addEventListener('click', function() {
      if (confirm('Clear all data?')) {
        localStorage.removeItem('libbyCheckerData');
        allBooks = [];
        filteredBooks = [];
        availableShelves = [];
        selectedShelves = [];
        document.getElementById('libraryUrl').value = '';
        document.getElementById('csvFile').value = '';
        document.getElementById('shelfFilters').classList.add('hidden');
        document.getElementById('results').classList.add('hidden');
        updateUI();
      }
    });

    // Update check button when library URL changes
    document.getElementById('libraryUrl').addEventListener('input', updateUI);
  </script>
</body>
</html>